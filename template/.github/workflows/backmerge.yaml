# This workflow automatically merges `master` into `develop` whenever a
# new version tag is pushed (v*).
#
# Key points:
# - Directly merges master into develop without creating a PR.
# - Skips CI on the merge commit using [skip ci] in the commit message.
# - The code being merged has already been tested as part of the release process.
# - This ensures develop stays up-to-date with release changes (version bumps, etc.).
#
# Required organization config:
# https://github.com/organizations/easyscience/settings/secrets/actions
# https://github.com/organizations/easyscience/settings/variables/actions
# - Actions secret:   EASYSCIENCE_APP_KEY  (GitHub App private key PEM)
# - Actions variable: EASYSCIENCE_APP_ID   (GitHub App ID)
#
# IMPORTANT:
# The GitHub App must be added to the develop branch ruleset bypass list.

name: Backmerge (master -> develop)

on:
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  backmerge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # full history with tags

      - name: Setup easyscience[bot]
        id: bot
        uses: ./.github/actions/setup-easyscience-bot
        with:
          app-id: ${{ vars.EASYSCIENCE_APP_ID }}
          private-key: ${{ secrets.EASYSCIENCE_APP_KEY }}
          repositories: ${{ github.event.repository.name }}

      - name: Merge master into develop
        run: |
          set -euo pipefail

          # Get the tag name variable to be used in the commit message
          TAG="${{ github.ref_name }}"

          # Ensure local master and develop branches exist and are up-to-date with origin
          git fetch origin master:master develop:develop

          # Switch to develop branch
          git checkout develop

          # Merge master into develop (no fast-forward to preserve history)
          # Use [skip ci] to avoid triggering CI - the code was already tested on master
          git merge master --no-ff -m "Backmerge: ${TAG} from master into develop [skip ci]"

          # Push the merge commit to develop
          # The easyscience app in bypass list allows this push
          git push origin develop

          echo "âœ… Successfully merged master (${TAG}) into develop"
